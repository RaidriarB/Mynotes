# CBC字节翻转攻击

>简介：CBC字节翻转攻击是一种针对CBC加密模式，通过改变密文，在未知密钥的情况下改变明文的方法。  
>如果想改变第一个Block中的明文，要求知道IV和明文。  
>如果想改变其他Block，要求密文可以随时回显，知道IV，知道明文。  
前置知识：CBC加密（什么思想，IV是什么，异或运算）

## CBC模式简单回顾

加密模式
![](https://mk0resourcesinfm536w.kinstacdn.com/wp-content/uploads/082113_1459_CBCByteFlip1.png)
解密模式
![](https://mk0resourcesinfm536w.kinstacdn.com/wp-content/uploads/082113_1459_CBCByteFlip2.png)
记明文的第i个block，密文的第i个block分别为P[i],C[i]；初始化向量为IV，而每一个block中第j个字节则放在第二维，记作P[i][j],C[i][j]，IV[j]；解密算法记作bcd(C[i],key)。  
根据CBC解密模式，可以列出如下关系：  
`关系1. bcd(C[i],key)^C[i-1] = P[i] (i>=2)`  
`关系2. bcd(C[1],key)^IV = P[1]`

## 攻击原理

首先用一张图直观地感受一下。
![](http://www.vuln.cn/wp-content/uploads/drops/20150814/2015081408372925051.jpg)

### 最简单的情况：只改变第一个block的明文

目的是通过控制IV使得P[1]变为P'[1]。  
根据上面的关系2继续推导  
`bcd(C[1],key)^IV^P[1]^P'[1] = P[1]^P[1]^P'[1]  = P'[1]`
我们能控制IV。注意：我们控制不了解密方式，只能遵守，也就是说关系2的数学形式不能改变。现加个括号方便观察：
`bcd(C[1],key)^【IV^P[1]^P'[1]】 = P'[1]`
因此我们要将原来的`IV`变为`IV^P[i]^P'[i]`,记作IV'。这样子P[1]就在解密后变为了P'[2]。

### 进阶：改变第i（i>1）个block的明文

#### 第一步

和上面的思想类似。  
目的是通过控制C（如果你理解加密模式，准确来讲是控制C[1~(i-1)]和IV），使得P[i]变为P'[i]。  
根据上面的关系1继续推导  
`bcd(C[i],key)^C[i-1]^P[i]^P'[i] = P[i]^P[i]^P'[i]  = P'[i];i>=2`
我们能控制C[i-1]，加个括号方便观察：
`bcd(C[i],key)^【C[i-1]^P[i]^P'[i]】 = P'[i];i>=2`
因此将原来的`C[i-1]`变为`C[i-1]^P[i]^P'[i]`,记作C'[i-1]。这样子P[i]就在解密后变为了P'[i]。

#### 但是

改变了C[i-1]，经过解密运算后的P[i-1]也变了。把这个变了的明文记作Pc[i-1]。我们想把这个明文还原回来，也就是要解决改变明文P[i-1]的问题。根据第一步，我们需要bcd(C[i-1],key),C[i-2],P[i-1]（请思考P[i-1]在这句话的意义。P[i-1]是密文C[i-1]根据bcd运算和异或运算得出的）。  
那么想把Pc[i-1]改为P[i-1],我们就需要用到上一段所言的「P[i-1]」在这里的对应，也就是更改后的密文块C'[i-1]经过了bcd运算和异或运算后的结果。  
因此，我们进行第一步更改后，要有进行解密运算的条件，并且能够得到运算的结果，才可以继续上一步的过程，对明文进行还原。（这个解密的过程一般是在Web服务器中，就需要想办法弄到错误回显）  

#### 最后

回到最简单的情况了，此时要把上一步导致的第一块明文的改变还原，我们就要控制IV做到这一点。

### 转换思维：改变整个明文块

请留意上一节「明文还原」的思想，在这个过程我们可以趁机把明文改变成任何想要的，只不过上一节我们想要的就是原来的明文。

## 例题 bugku login4（Web最后一题）

这里暂时不能上传图片，就简单描述思路吧，详解见wp。  
刚进去一个login框，随便输入用户名密码就可以进入，但页面会提示只有admin才能看flag，而login程序不允许admin这个用户名登录。  
登录后查看cookie，发现了cipher和iv两个cookie。  
我们知道IV，不知道明文，不确定密文可否回显。  
尝试改变cookie的值，但我们不知道明文和加密方式，没有办法控制，页面返回Error，也没有回显。所以现在要想办法确定明文是什么。  
进行目录扫描，发现源码泄漏了index.php。去分析发现了明文的生成方法，即php的一个序列化对象。加密方法是aes-128-cbc，iv随机生成。  
接下来就可以进行CBC字节翻转攻击了。
